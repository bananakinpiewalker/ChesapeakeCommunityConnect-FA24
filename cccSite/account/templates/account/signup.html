<a class="signup-modal-trigger" data-target="signup-modal"> Sign Up </a>

<div id="signup-modal" class="modal">
    {% csrf_token %}
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title has-text-left">Sign Up</p>
            <button type="button" class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
            <div class="field">
                <label class="label">Username</label>
                <div class="control">
                    <input class="input is-rounded" type="text" name="username" id="signup_username">
                </div>
                <p class="help" id="signup_username_helper"></p>
            </div>
            <div class="field">
                <label class="label">Email</label>
                <div class="control">
                    <input class="input is-rounded" type="email" name="email" id="signup_email">
                </div>
                <p class="help" id="signup_email_helper"></p>
            </div>
            <div class="field">
                <label class="label">Password</label>
                <div class="control">
                    <input class="input is-rounded" type="password" name="password" id="signup_password">
                </div>
                <p class="help" id="signup_password_helper"></p>
            </div>
            <div class="field">
                <label class="label">Confirm Password</label>
                <div class="control">
                    <input class="input is-rounded" type="password" name="password" id="signup_confirm_password">
                </div>
                <p class="help" id="signup_confirm_password_helper"></p>
            </div>
        </section>
        <footer class="modal-card-foot">
            <div class="control">
                <button type="submit" class="button is-success" id="signup" disabled>Sign Up</button>
                <button type="button" class="button is-danger sign-in-up-cancel">Cancel</button>
            </div>
        </footer>
    </div>
</div>


<script>

    let signup_username = document.getElementById("signup_username");
    let signup_username_helper = document.getElementById("signup_username_helper");
    var signup_usernameIsValid = false;

    let signup_email = document.getElementById("signup_email");
    let signup_email_helper = document.getElementById("signup_email_helper");
    const signup_emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
    var signup_emailIsValid = false;

    let signup_password = document.getElementById("signup_password");
    let signup_password_helper = document.getElementById("signup_password_helper");
    var signup_passwordIsValid = false;

    let signup_confirm_password = document.getElementById("signup_confirm_password");
    let signup_confirm_password_helper = document.getElementById("signup_confirm_password_helper");
    var signup_confirm_passwordIsValid = false;

    const signup_passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*#?&()])[A-Za-z\d@$!%*#?&()]{8,}$/;

    let submit_button = document.getElementById("signup");

    $("#signup_username").change(function (e) {
        if ($(signup_username).val() == "") {
            signup_username.classList.remove("is-danger");
            signup_username_helper.classList.remove("is-danger");
            signup_username.classList.remove("is-success");
            signup_username_helper.classList.remove("is-success");
            signup_username_helper.textContent = "";
            signup_usernameIsValid = false;
            submit_button.disabled = true;
        } else {
            $.ajax({
                type: "GET",
                url: "ajax/username_validation/",
                data: {
                    username: $(signup_username).val(),
                },
                success: function (data) {
                    if (data.is_taken) {
                        signup_username.classList.add("is-danger");
                        signup_username.classList.remove("is-success");
                        signup_username_helper.classList.add("is-danger");
                        signup_username_helper.classList.remove("is-success");
                        signup_username_helper.textContent = "That username is taken.";
                        signup_usernameIsValid = false;
                        submit_button.disabled = true;
                    } else {
                        signup_username.classList.remove("is-danger");
                        signup_username.classList.add("is-success");
                        signup_username_helper.classList.remove("is-danger");
                        signup_username_helper.classList.add("is-success");
                        signup_username_helper.textContent = "That username is available.";
                        signup_usernameIsValid = true;
                        allIsValid();
                    }
                }
            });
        }
    });
    $("#signup_email").change(function (e) {

        if ($(signup_email).val() == "") {
            signup_email.classList.remove("is-danger");
            signup_email_helper.classList.remove("is-danger");
            signup_email.classList.remove("is-success");
            signup_email_helper.classList.remove("is-success");
            signup_email_helper.textContent = "";
            signup_emailIsValid = false;
            submit_button.disabled = true;
        } else if (signup_emailRegex.test($(signup_email).val())) {
            $.ajax({
                type: "GET",
                url: "ajax/email_validation/",
                data: {
                    email: $(signup_email).val(),
                },
                success: function (data) {
                    
                    if (data.is_taken) {
                        signup_email.classList.add("is-danger");
                        signup_email.classList.remove("is-success");
                        signup_email_helper.classList.add("is-danger");
                        signup_email_helper.classList.remove("is-success");
                        signup_email_helper.textContent = "That email is already being used.";
                        signup_emailIsValid = false;
                        submit_button.disabled = true;
                    } else {
                        signup_email.classList.remove("is-danger");
                        signup_email.classList.add("is-success");
                        signup_email_helper.classList.remove("is-danger");
                        signup_email_helper.classList.add("is-success");
                        signup_email_helper.textContent = "That email is available.";
                        signup_emailIsValid = true;
                        allIsValid();
                    }
                }
            });
        } else {
            signup_email.classList.add("is-danger");
            signup_email.classList.remove("is-success");
            signup_email_helper.classList.add("is-danger");
            signup_email_helper.classList.remove("is-success");
            signup_email_helper.textContent = "That email is invalid.";
            signup_emailIsValid = false;
            submit_button.disabled = true;
        }
    });
    $("#signup_password").change(function (e) {

        if ($(signup_password).val() == "") {
            signup_password.classList.remove("is-danger");
            signup_password_helper.classList.remove("is-danger");
            signup_password.classList.remove("is-success");
            signup_password_helper.classList.remove("is-success");
            signup_password_helper.textContent = "";
            signup_passwordIsValid = false;
            submit_button.disabled = true;
        } else if (signup_passwordRegex.test($(signup_password).val())) {
            signup_password.classList.remove("is-danger");
            signup_password.classList.add("is-success");
            signup_password_helper.classList.remove("is-danger");
            signup_password_helper.classList.add("is-success");
            signup_password_helper.textContent = "That password is valid.";
            signup_passwordIsValid = true;
            confirm_signup_password_update();
            allIsValid();
        } else {
            signup_password.classList.add("is-danger");
            signup_password.classList.remove("is-success");
            signup_password_helper.classList.add("is-danger");
            signup_password_helper.classList.remove("is-success");
            signup_password_helper.textContent = "That password is invalid.";
            signup_passwordIsValid = false;
            confirm_signup_password_update();
            submit_button.disabled = true;
        }
    });

    
    $("#signup_confirm_password").change(function (e) {
        confirm_signup_password_update();
    });
    function confirm_signup_password_update() {
        if ($(signup_confirm_password).val() == "" || !signup_passwordRegex.test($(signup_password).val())) {
            signup_confirm_password.classList.remove("is-danger");
            signup_confirm_password_helper.classList.remove("is-danger");
            signup_confirm_password.classList.remove("is-success");
            signup_confirm_password_helper.classList.remove("is-success");
            signup_confirm_password_helper.textContent = "";
            signup_confirm_passwordIsValid = false;
            submit_button.disabled = true;
        } else if ($(signup_confirm_password).val() == $(signup_password).val()) {
            signup_confirm_password.classList.remove("is-danger");
            signup_confirm_password.classList.add("is-success");
            signup_confirm_password_helper.classList.remove("is-danger");
            signup_confirm_password_helper.classList.add("is-success");
            signup_confirm_password_helper.textContent = "The passwords match.";
            signup_confirm_passwordIsValid = true;
            allIsValid();
        } else {
            signup_confirm_password.classList.add("is-danger");
            signup_confirm_password.classList.remove("is-success");
            signup_confirm_password_helper.classList.add("is-danger");
            signup_confirm_password_helper.classList.remove("is-success");
            signup_confirm_password_helper.textContent = "The passwords don't match.";
            signup_confirm_passwordIsValid = false;
            submit_button.disabled = true;
        }
    }
    function allIsValid() {
        if (signup_usernameIsValid && signup_emailIsValid && signup_passwordIsValid && signup_confirm_passwordIsValid) {
            submit_button.disabled = false;
        }
    }

    $("#signup-modal").on("click", "#signup", function (e) {
        
        e.preventDefault();
        $.ajax({
            url: "signup/",
            type: "POST",
            data: {
                username: $(signup_username).val(),
                email: $(signup_email).val(),
                password1: $(signup_password).val(),
                password2: $(signup_confirm_password).val(),
                csrfmiddlewaretoken: $("input[name='csrfmiddlewaretoken']").val()
            },
            success:function(response) {
                location.reload(true);
            }
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        // Functions to open and close a modal
        function openModal($el) {
          $el.classList.add('is-active');
        }
      
        function closeModal($el) {
          $el.classList.remove('is-active');
          signup_username.classList.remove("is-danger");
          signup_username_helper.classList.remove("is-danger");
          signup_username.classList.remove("is-success");
          signup_username_helper.classList.remove("is-success");
          signup_username.value = "";
          signup_username_helper.textContent = "";
          signup_usernameIsValid = false;

          signup_email.classList.remove("is-danger");
          signup_email_helper.classList.remove("is-danger");
          signup_email.classList.remove("is-success");
          signup_email_helper.classList.remove("is-success");
          signup_email.value = "";
          signup_email_helper.textContent = "";
          signup_emailIsValid = false;

          signup_password.classList.remove("is-danger");
          signup_password_helper.classList.remove("is-danger");
          signup_password.classList.remove("is-success");
          signup_password_helper.classList.remove("is-success");
          signup_password.value = "";
          signup_password_helper.textContent = "";
          signup_passwordIsValid = false;

          signup_confirm_password.classList.remove("is-danger");
          signup_confirm_password_helper.classList.remove("is-danger");
          signup_confirm_password.classList.remove("is-success");
          signup_confirm_password_helper.classList.remove("is-success");
          signup_confirm_password.value = "";
          signup_confirm_password_helper.textContent = "";
          signup_confirm_passwordIsValid = false;

          submit_button.disabled = true;
        }
      
        function closeAllModals() {
          (document.querySelectorAll('.modal') || []).forEach(($modal) => {
            closeModal($modal);
          });
        }
      
        // Add a click event on buttons to open a specific modal
        (document.querySelectorAll('.signup-modal-trigger') || []).forEach(($trigger) => {
          const modal = $trigger.dataset.target;
          const $target = document.getElementById(modal);
      
          $trigger.addEventListener('click', () => {
            openModal($target);
          });
        });
      
        // Add a click event on various child elements to close the parent modal
        (document.querySelectorAll('.modal-background, .modal-close, .modal-card-head .delete, .modal-card-foot .sign-in-up-cancel') || []).forEach(($close) => {
          const $target = $close.closest('.modal');
      
          $close.addEventListener('click', () => {
            closeModal($target);
          });
        });
      
        // Add a keyboard event to close all modals
        document.addEventListener('keydown', (event) => {
          if(event.key === "Escape") {
            closeAllModals();
          }
        });
      });
</script>